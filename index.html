<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸€æ—¥ä¹‹è¨ˆ | Weather Focus</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Noto+Sans+TC:wght@300;400;500&display=swap" rel="stylesheet">

    <style>
        :root {
            /* SKIMS é¢¨æ ¼è‰²ç¥¨ */
            --sk-bg: #F3F0EB;
            --sk-card-bg: #FDFCFAE6;
            --sk-text-primary: #2E2E2E;
            --sk-text-secondary: #6B6661;
            --sk-accent: #918578;
            --sk-border: #E6E2D8;
            --sk-highlight: #D8D0C5;
            
            --radius-lg: 24px;
            --radius-md: 16px;
            --shadow-soft: 0 10px 40px -10px rgba(120, 110, 100, 0.1);
            --sidebar-width: 260px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: var(--sk-bg);
            color: var(--sk-text-primary);
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* === Loading === */
        .loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--sk-bg);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 999; transition: opacity 0.5s ease;
        }
        .loading-text {
            font-size: 0.9rem; letter-spacing: 0.2em; color: var(--sk-text-secondary);
            margin-top: 20px; text-transform: uppercase; animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { opacity: 0.4; } 50% { opacity: 1; } 100% { opacity: 0.4; } }

        /* === é ‚éƒ¨ç‹€æ…‹åˆ— & èªç³»åˆ‡æ› === */
        .status-bar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 24px;
            background: rgba(243, 240, 235, 0.95);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            z-index: 100; flex-shrink: 0;
        }

        .brand-group { display: flex; align-items: center; gap: 15px; }
        .brand-title { font-size: 1.1rem; font-weight: 600; letter-spacing: 0.1em; }
        .date-pill {
            font-size: 0.75rem; color: var(--sk-text-secondary);
            background: rgba(255,255,255,0.5); padding: 4px 12px;
            border-radius: 20px; border: 1px solid var(--sk-border);
        }

        /* èªç³»åˆ‡æ›å™¨ */
        .lang-switcher {
            display: flex; gap: 5px; background: rgba(255,255,255,0.5);
            padding: 4px; border-radius: 20px; border: 1px solid var(--sk-border);
        }
        .lang-btn {
            border: none; background: none; cursor: pointer;
            padding: 4px 10px; border-radius: 16px;
            font-size: 0.75rem; font-weight: 500; color: var(--sk-text-secondary);
            transition: all 0.2s;
        }
        .lang-btn.active {
            background: var(--sk-text-primary); color: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .lang-btn:hover:not(.active) { color: var(--sk-text-primary); }

        /* === æ‡‰ç”¨ç¨‹å¼ä¸»ä½ˆå±€ === */
        .app-wrapper {
            display: flex; flex: 1; height: calc(100vh - 60px);
            overflow: hidden; opacity: 0; animation: fadeIn 0.8s ease forwards;
        }
        @keyframes fadeIn { to { opacity: 1; } }

        /* === å´é‚Šç›®éŒ„ === */
        .sidebar {
            width: var(--sidebar-width);
            background: rgba(255, 255, 255, 0.3);
            border-right: 1px solid var(--sk-border);
            overflow-y: auto; padding: 20px 0;
            display: flex; flex-direction: column; flex-shrink: 0;
        }
        .sidebar-header {
            padding: 0 24px 15px; font-size: 0.75rem;
            color: var(--sk-text-secondary); letter-spacing: 0.1em; text-transform: uppercase;
        }
        .city-nav-item {
            padding: 14px 24px; cursor: pointer; transition: all 0.2s ease;
            font-size: 0.95rem; color: var(--sk-text-secondary);
            display: flex; justify-content: space-between; align-items: center;
        }
        .city-nav-item:hover { background: rgba(255, 255, 255, 0.5); color: var(--sk-text-primary); }
        .city-nav-item.active {
            background: #fff; color: var(--sk-text-primary); font-weight: 600;
            border-left: 3px solid var(--sk-accent); padding-left: 21px;
        }
        /* å·²ç§»é™¤æº«åº¦é¡¯ç¤ºï¼Œåƒ…ä¿ç•™åç¨± */

        /* === ä¸»è¦å…§å®¹å€ === */
        .main-content {
            flex: 1; display: flex; justify-content: center; align-items: center;
            padding: 40px; overflow-y: auto;
            background: linear-gradient(135deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.4) 100%);
        }

        .focus-card {
            background: var(--sk-card-bg); border: 1px solid var(--sk-border);
            border-radius: var(--radius-lg); padding: 40px;
            width: 100%; max-width: 500px;
            box-shadow: var(--shadow-soft); animation: slideUp 0.5s ease;
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .focus-header { text-align: center; margin-bottom: 30px; }
        .focus-city-name { font-size: 2rem; font-weight: 300; margin-bottom: 10px; }
        .focus-desc {
            font-size: 1rem; color: var(--sk-text-secondary); display: inline-block;
            background: rgba(0,0,0,0.03); padding: 4px 12px; border-radius: 20px;
        }
        .focus-body {
            display: flex; flex-direction: column; align-items: center; gap: 20px; margin-bottom: 40px;
        }
        .focus-icon { font-size: 6rem; margin: 10px 0; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.1)); }
        .focus-temp { font-size: 4rem; font-weight: 200; line-height: 1; }
        .focus-rain {
            color: var(--sk-text-secondary); font-size: 0.9rem; margin-top: 10px;
            display: flex; align-items: center; gap: 6px;
        }
        .focus-advice-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
            border-top: 1px solid var(--sk-border); padding-top: 30px;
        }
        .advice-box {
            background: rgba(255,255,255,0.6); padding: 15px;
            border-radius: var(--radius-md); text-align: center;
            border: 1px solid rgba(0,0,0,0.03);
        }
        .advice-icon-lg { font-size: 1.5rem; margin-bottom: 8px; display: block; }
        .advice-text { font-size: 0.9rem; color: var(--sk-text-primary); }

        /* === RWD æ‰‹æ©Ÿç‰ˆ === */
        @media (max-width: 768px) {
            .app-wrapper { flex-direction: column; }
            .sidebar {
                width: 100%; height: auto; flex-direction: row;
                overflow-x: auto; overflow-y: hidden; border-right: none;
                border-bottom: 1px solid var(--sk-border); padding: 10px; background: var(--sk-bg);
            }
            .sidebar-header { display: none; }
            .city-nav-item {
                flex-shrink: 0; padding: 8px 16px; border-radius: 20px;
                margin-right: 8px; border: 1px solid transparent;
            }
            .city-nav-item.active {
                border-left: 1px solid transparent; background: var(--sk-text-primary); color: #fff;
            }
            .main-content { padding: 20px; align-items: flex-start; }
            .status-bar { flex-direction: column; gap: 10px; align-items: flex-start; }
            .lang-switcher { align-self: flex-end; margin-top: -35px; } /* æ‰‹æ©Ÿç‰ˆèª¿æ•´ä½ç½® */
        }
    </style>
</head>
<body>

    <div id="loading" class="loading-screen">
        <svg width="50" height="50" viewBox="0 0 50 50">
            <circle cx="25" cy="25" r="20" fill="none" stroke="#918578" stroke-width="2" stroke-linecap="round">
                <animate attributeName="stroke-dasharray" from="0 126" to="126 126" dur="2s" repeatCount="indefinite" />
                <animateTransform attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="2s" repeatCount="indefinite" />
            </circle>
        </svg>
        <div class="loading-text" id="loadingText">PLANNING YOUR DAY</div>
    </div>

    <div class="status-bar">
        <div class="brand-group">
            <div class="brand-title" id="appTitle">ä¸€æ—¥ä¹‹è¨ˆ</div>
            <div id="currentDate" class="date-pill">...</div>
        </div>
        
        <div class="lang-switcher">
            <button class="lang-btn active" onclick="setLanguage('zh-TW')">ä¸­</button>
            <button class="lang-btn" onclick="setLanguage('en')">EN</button>
            <button class="lang-btn" onclick="setLanguage('es')">ES</button>
        </div>
    </div>

    <div class="app-wrapper" id="appContent" style="display: none;">
        
        <aside class="sidebar">
            <div class="sidebar-header" id="sidebarTitle">é¸æ“‡åœ°å€ (åŒ—è‡³å—)</div>
            <div id="city-menu"></div>
        </aside>

        <main class="main-content">
            <div id="weather-display-area"></div>
        </main>

    </div>

    <script>
        const API_URL = 'http://localhost:3000'; // é€™è£¡çš„ 3000 è¦æ›æˆä½ å‰›å‰›æ¸¬è©¦æˆåŠŸçš„æ•¸å­—

        // === I18n è³‡æ–™èˆ‡è¨­å®š ===
        let currentLang = 'zh-TW';

        // å­—å…¸ï¼šä»‹é¢æ–‡å­—
        const TRANSLATIONS = {
            'zh-TW': {
                appTitle: 'ä¸€æ—¥ä¹‹è¨ˆ',
                loading: 'è¦åŠƒæ‚¨çš„ä¸€å¤©',
                sidebarTitle: 'åœ°å€é¸æ“‡ (åŒ—è‡³å—)',
                rainLabel: 'é™é›¨æ©Ÿç‡',
                advice: {
                    noUmbrella: 'ç„¡éœ€å¸¶å‚˜',
                    bringUmbrella: 'è¨˜å¾—å¸¶å‚˜',
                    comfy: 'èˆ’é©ç©¿æ­',
                    tshirt: 'é€æ°£çŸ­è¢–',
                    jacket: 'åŠ ä¸Šå¤–å¥—'
                }
            },
            'en': {
                appTitle: 'Daily Plan',
                loading: 'Planning Your Day',
                sidebarTitle: 'Select Region (N to S)',
                rainLabel: 'Rain Chance',
                advice: {
                    noUmbrella: 'No Umbrella',
                    bringUmbrella: 'Take Umbrella',
                    comfy: 'Comfortable',
                    tshirt: 'Light T-Shirt',
                    jacket: 'Wear Jacket'
                }
            },
            'es': {
                appTitle: 'Plan Diario',
                loading: 'Planificando su dÃ­a',
                sidebarTitle: 'Seleccionar RegiÃ³n',
                rainLabel: 'Prob. Lluvia',
                advice: {
                    noUmbrella: 'Sin paraguas',
                    bringUmbrella: 'Llevar paraguas',
                    comfy: 'CÃ³modo',
                    tshirt: 'Camiseta',
                    jacket: 'Llevar chaqueta'
                }
            }
        };

        // å­—å…¸ï¼šåŸå¸‚åç¨±å°ç…§ (APIä¸­æ–‡ -> EN/ES)
        // é€™è£¡ EN å’Œ ES é€šå¸¸å…±ç”¨ç¾…é¦¬æ‹¼éŸ³ï¼Œä½†å¦‚æœæœ‰ç‰¹å®šå·®ç•°å¯åˆ†é–‹
        const CITY_NAMES = {
            "åŸºéš†å¸‚": "Keelung City",
            "è‡ºåŒ—å¸‚": "Taipei City",
            "æ–°åŒ—å¸‚": "New Taipei City",
            "æ¡ƒåœ’å¸‚": "Taoyuan City",
            "æ–°ç«¹å¸‚": "Hsinchu City",
            "æ–°ç«¹ç¸£": "Hsinchu County",
            "è‹—æ —ç¸£": "Miaoli County",
            "è‡ºä¸­å¸‚": "Taichung City",
            "å½°åŒ–ç¸£": "Changhua County",
            "å—æŠ•ç¸£": "Nantou County",
            "é›²æ—ç¸£": "Yunlin County",
            "å˜‰ç¾©å¸‚": "Chiayi City",
            "å˜‰ç¾©ç¸£": "Chiayi County",
            "è‡ºå—å¸‚": "Tainan City",
            "é«˜é›„å¸‚": "Kaohsiung City",
            "å±æ±ç¸£": "Pingtung County",
            "å®œè˜­ç¸£": "Yilan County",
            "èŠ±è“®ç¸£": "Hualien County",
            "è‡ºæ±ç¸£": "Taitung County",
            "æ¾æ¹–ç¸£": "Penghu County",
            "é‡‘é–€ç¸£": "Kinmen County",
            "é€£æ±Ÿç¸£": "Lienchiang County"
        };

        // æ’åºè¨­å®š
        const CITY_ORDER = Object.keys(CITY_NAMES); // ä½¿ç”¨ä¸Šé¢çš„ keys ä½œç‚ºæ’åºä¾æ“š

        let weatherData = [];
        let currentCityIndex = 0;

        // === è¼”åŠ©å‡½å¼ ===

        // å–å¾—ç¿»è­¯å¾Œçš„åŸå¸‚å
        function getLocalizedCityName(originalName) {
            if (currentLang === 'zh-TW') return originalName;
            return CITY_NAMES[originalName] || originalName;
        }

        // æ ¹æ“š Icon é¡å‹å–å¾—ç¿»è­¯å¾Œçš„å¤©æ°£æè¿°
        // å› ç‚º API å›å‚³çš„æè¿°å¾ˆè¤‡é›œï¼Œæˆ‘å€‘ç”¨ "é¡å‹" ä¾†å°æ‡‰ç¿»è­¯
        function getLocalizedWeatherDesc(desc) {
            if (currentLang === 'zh-TW') return desc; // ä¸­æ–‡ç›´æ¥å›å‚³ API è³‡æ–™

            // ç°¡æ˜“å°æ‡‰é‚è¼¯
            if (desc.includes('æ™´') && !desc.includes('é›²') && !desc.includes('é™°')) {
                return currentLang === 'en' ? 'Sunny' : 'Soleado';
            }
            if (desc.includes('å¤šé›²') || desc.includes('é™°')) {
                if(desc.includes('é›¨')) return currentLang === 'en' ? 'Cloudy/Rain' : 'Nublado/Lluvia';
                return currentLang === 'en' ? 'Cloudy' : 'Nublado';
            }
            if (desc.includes('é›¨')) return currentLang === 'en' ? 'Rainy' : 'Lluvioso';
            if (desc.includes('éœ§')) return currentLang === 'en' ? 'Foggy' : 'Niebla';
            
            return currentLang === 'en' ? 'Partly Cloudy' : 'Parcialmente Nublado';
        }

        function getWeatherIcon(desc) {
            if (desc.includes('æ™´')) return 'â˜€ï¸';
            if (desc.includes('å¤šé›²') && desc.includes('æ™´')) return 'â›…';
            if (desc.includes('å¤šé›²') || desc.includes('é™°')) return 'â˜ï¸';
            if (desc.includes('é›¨')) return 'ğŸŒ§ï¸';
            if (desc.includes('é›·')) return 'â›ˆï¸';
            if (desc.includes('éœ§')) return 'ğŸŒ«ï¸';
            return 'ğŸŒ¥ï¸';
        }

        function getAdvice(rainProb, maxTemp) {
            const t = TRANSLATIONS[currentLang].advice;
            let rainAdvice = { icon: "ğŸŒ‚", text: t.noUmbrella };
            let clothAdvice = { icon: "ğŸ‘•", text: t.comfy };

            if (parseInt(rainProb) > 30) {
                rainAdvice = { icon: "â˜‚ï¸", text: t.bringUmbrella };
            }

            const temp = parseInt(maxTemp);
            if (temp >= 28) {
                clothAdvice = { icon: "ğŸ½", text: t.tshirt };
            } else if (temp <= 20) {
                clothAdvice = { icon: "ğŸ§¥", text: t.jacket };
            }
            return { rainAdvice, clothAdvice };
        }

        // === æ¸²æŸ“å‡½å¼ ===

        function updateStaticText() {
            const t = TRANSLATIONS[currentLang];
            document.getElementById('appTitle').textContent = t.appTitle;
            document.getElementById('sidebarTitle').textContent = t.sidebarTitle;
            document.getElementById('loadingText').textContent = t.loading;
        }

        function renderSidebar() {
            const menuContainer = document.getElementById('city-menu');
            menuContainer.innerHTML = weatherData.map((city, index) => {
                const isActive = index === currentCityIndex ? 'active' : '';
                const displayName = getLocalizedCityName(city.cityName);
                
                // éœ€æ±‚ï¼šä¸é¡¯ç¤ºæº«åº¦ï¼Œåƒ…é¡¯ç¤ºåç¨±
                return `
                    <div class="city-nav-item ${isActive}" onclick="switchCity(${index})">
                        <span>${displayName}</span>
                    </div>
                `;
            }).join('');

            // æ‰‹æ©Ÿç‰ˆè‡ªå‹•æ²å‹•
            if(window.innerWidth <= 768) {
                const activeItem = menuContainer.children[currentCityIndex];
                if(activeItem) {
                    activeItem.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                }
            }
        }

        function renderMainDisplay() {
            const container = document.getElementById('weather-display-area');
            const city = weatherData[currentCityIndex];
            if (!city) return;

            const t = TRANSLATIONS[currentLang];
            const icon = getWeatherIcon(city.weatherDescription);
            const { rainAdvice, clothAdvice } = getAdvice(city.rainProbability, city.maxTemperature);
            
            // ç¿»è­¯è³‡æ–™
            const displayName = getLocalizedCityName(city.cityName);
            const displayDesc = getLocalizedWeatherDesc(city.weatherDescription);

            container.innerHTML = `
                <div class="focus-card" key="${city.cityName}-${currentLang}">
                    <div class="focus-header">
                        <div class="focus-city-name">${displayName}</div>
                        <div class="focus-desc">${displayDesc}</div>
                    </div>
                    
                    <div class="focus-body">
                        <div class="focus-icon">${icon}</div>
                        <div class="focus-temp">${city.minTemperature}Â° - ${city.maxTemperature}Â°</div>
                        <div class="focus-rain">
                            <span>ğŸ’§</span> ${t.rainLabel} ${city.rainProbability}%
                        </div>
                    </div>

                    <div class="focus-advice-grid">
                        <div class="advice-box">
                            <span class="advice-icon-lg">${rainAdvice.icon}</span>
                            <div class="advice-text">${rainAdvice.text}</div>
                        </div>
                        <div class="advice-box">
                            <span class="advice-icon-lg">${clothAdvice.icon}</span>
                            <div class="advice-text">${clothAdvice.text}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // === åŠŸèƒ½å‡½å¼ ===

        window.switchCity = function(index) {
            currentCityIndex = index;
            renderSidebar();
            renderMainDisplay();
        }

        window.setLanguage = function(lang) {
            currentLang = lang;
            
            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if(btn.textContent.includes(lang === 'zh-TW' ? 'ä¸­' : lang.toUpperCase())) {
                    btn.classList.add('active');
                }
            });

            // æ›´æ–°æ‰€æœ‰ç•«é¢
            updateStaticText();
            renderSidebar();
            renderMainDisplay();
        }

        async function init() {
            const now = new Date();
            const dateStr = `${now.getMonth() + 1}/${now.getDate()}`;
            document.getElementById('currentDate').textContent = dateStr;

            updateStaticText(); // åˆå§‹åŒ–éœæ…‹æ–‡å­—

            try {
                await new Promise(r => setTimeout(r, 800));
                const response = await fetch(API_URL);
                const result = await response.json();

                if (result.success) {
                    weatherData = result.data.sort((a, b) => {
                        return CITY_ORDER.indexOf(a.cityName) - CITY_ORDER.indexOf(b.cityName);
                    });

                    renderSidebar();
                    renderMainDisplay();

                    const loading = document.getElementById('loading');
                    loading.style.opacity = '0';
                    setTimeout(() => {
                        loading.style.display = 'none';
                        document.getElementById('appContent').style.display = 'flex';
                    }, 500);
                }
            } catch (error) {
                console.error("Fetch error:", error);
                document.getElementById('loadingText').textContent = "CONNECTION ERROR";
            }
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
